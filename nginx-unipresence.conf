# ============================================================================
# NGINX Configuration for Unipresence (Unified Server)
# ============================================================================
# Server runs on port 41201 (backend + frontend)
# Nginx acts as reverse proxy with SSL termination
# ============================================================================

# Upstream - your unified server
upstream unipresence_app {
    server 127.0.0.1:41201;
    keepalive 64;
}

# HTTP Server - Redirect to HTTPS (uncomment jika sudah setup SSL)
# server {
#     listen 80;
#     listen [::]:80;
#     server_name your-domain.com www.your-domain.com;
#     
#     # Redirect to HTTPS
#     return 301 https://$server_name$request_uri;
# }

# Main Server Block
server {
    # HTTP (untuk development/local)
    listen 80;
    listen [::]:80;
    
    # HTTPS (uncomment setelah setup SSL)
    # listen 443 ssl http2;
    # listen [::]:443 ssl http2;
    
    # Domain
    server_name localhost;  # Ganti dengan domain Anda, misal: unipresence.yourdomain.com
    
    # ========================================================================
    # SSL Configuration (uncomment setelah dapat SSL certificate)
    # ========================================================================
    # ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    # 
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;
    # ssl_prefer_server_ciphers on;
    # ssl_session_cache shared:SSL:10m;
    # ssl_session_timeout 10m;
    
    # ========================================================================
    # Logging
    # ========================================================================
    access_log /var/log/nginx/unipresence_access.log;
    error_log /var/log/nginx/unipresence_error.log;
    
    # ========================================================================
    # Security Headers
    # ========================================================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # ========================================================================
    # Client Settings
    # ========================================================================
    client_max_body_size 10M;  # Max upload size (untuk foto wajah)
    client_body_timeout 60s;
    client_header_timeout 60s;
    
    # ========================================================================
    # Proxy Settings
    # ========================================================================
    
    # Root location - proxy semua request ke unified server
    location / {
        proxy_pass http://unipresence_app;
        
        # Proxy headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Buffering
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # ========================================================================
    # Static File Caching (Optional optimization)
    # ========================================================================
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://unipresence_app;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        
        # Cache static files
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # ========================================================================
    # Health Check (Optional)
    # ========================================================================
    location /health {
        proxy_pass http://unipresence_app/api/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }
    
    # ========================================================================
    # Block hidden files
    # ========================================================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================================================
# CONFIGURATION NOTES
# ============================================================================
# 
# 1. BASIC SETUP (HTTP Only):
#    - Ganti 'localhost' dengan domain/IP Anda
#    - Copy file ini ke: /etc/nginx/sites-available/unipresence
#    - Enable: sudo ln -s /etc/nginx/sites-available/unipresence /etc/nginx/sites-enabled/
#    - Test: sudo nginx -t
#    - Reload: sudo systemctl reload nginx
#
# 2. SSL SETUP (HTTPS):
#    - Get certificate dengan certbot:
#      sudo certbot --nginx -d your-domain.com
#    - Atau uncomment SSL configuration dan update paths
#    - Certbot akan auto-update config file
#
# 3. DOMAIN SETUP:
#    - Point your domain A record ke server IP
#    - Update server_name dengan domain Anda
#    - Wait for DNS propagation (5-30 menit)
#
# 4. FIREWALL:
#    - Open port 80: sudo ufw allow 80/tcp
#    - Open port 443: sudo ufw allow 443/tcp
#    - Port 41201 tidak perlu dibuka (internal only)
#
# 5. TESTING:
#    - Local: http://localhost atau http://YOUR_IP
#    - Domain: http://your-domain.com
#    - HTTPS: https://your-domain.com (setelah SSL setup)
#
# ============================================================================
